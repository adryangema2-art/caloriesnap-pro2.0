<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CalorieSnap Pro — NutriAdryan</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --accent:#167d7a; --accent-dark:#0f6b63; --bg:#f4fbfb; --card:#ffffff; --muted:#666;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,Helvetica,sans-serif;background:var(--bg);color:#111}
  /* video background */
  .bg-wrap{position:fixed;inset:0;z-index:-2;overflow:hidden}
  .bg-video{position:absolute;left:50%;top:50%;min-width:100%;min-height:100%;width:auto;height:auto;transform:translate(-50%,-50%);object-fit:cover;filter:brightness(0.6) saturate(1.05)}
  .bg-slideshow{position:absolute;inset:0;background-size:cover;background-position:center;filter:brightness(0.6);animation:slide 20s infinite}
  @keyframes slide{0%{background-image:var(--img-0)}25%{background-image:var(--img-1)}50%{background-image:var(--img-2)}75%{background-image:var(--img-3)}100%{background-image:var(--img-0)}}
  /* main layout */
  .wrap{max-width:1100px;margin:40px auto;padding:20px;position:relative;z-index:2}
  header{display:flex;align-items:center;gap:18px;color:white}
  .brand{font-family:Poppins,Inter,Arial;font-weight:700;font-size:1.6rem}
  .hero{display:flex;gap:20px;align-items:flex-start}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.95),var(--card));border-radius:14px;padding:18px;box-shadow:0 8px 30px rgba(15,20,30,0.12);width:100%}
  .left{flex:1;min-width:320px}
  .right{width:420px}
  h1{margin:0 0 8px;font-family:Poppins,Inter;font-weight:700;color:#062e2a}
  p.lead{margin:0 0 12px;color:var(--muted);font-size:0.98rem}
  label{font-weight:600;margin-bottom:6px;display:block}
  input[type=file],select{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e6e6}
  .btn{background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;color:var(--accent);border:2px solid rgba(255,255,255,0.16)}
  .preview{border-radius:10px;overflow:hidden;border:1px solid #eee;margin-top:12px}
  img.preview-img{max-width:100%;display:block}
  .results{margin-top:12px}
  .pred-item{display:flex;justify-content:space-between;padding:10px;border-radius:8px;background:#fff;border:1px solid #f0f0f0;margin-bottom:8px;align-items:center}
  .muted{color:var(--muted);font-size:0.9rem}
  footer{margin-top:18px;color:rgba(255,255,255,0.9);font-size:0.95rem}
  /* chat */
  .chat-toggle{position:fixed;right:20px;bottom:20px;z-index:60}
  .chat-btn{width:60px;height:60px;border-radius:50%;background:var(--accent);border:none;color:white;font-weight:700;box-shadow:0 8px 20px rgba(15,20,30,0.18);cursor:pointer}
  .chat-panel{position:fixed;right:20px;bottom:90px;width:360px;background:rgba(255,255,255,0.98);border-radius:12px;box-shadow:0 18px 40px rgba(10,10,10,0.2);overflow:hidden;z-index:70;display:flex;flex-direction:column}
  .chat-header{padding:12px;background:linear-gradient(90deg,var(--accent),var(--accent-dark));color:white;font-weight:700}
  .chat-body{padding:12px;flex:1;overflow:auto;max-height:360px}
  .chat-input{display:flex;gap:8px;padding:12px;border-top:1px solid #eee}
  .chat-input input{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd}
  .chat-message{margin-bottom:10px}
  .msg-user{background:#e6fffa;padding:8px;border-radius:8px;display:inline-block}
  .msg-bot{background:#f1f1f1;padding:8px;border-radius:8px;display:inline-block}
  /* responsive */
  @media(max-width:920px){.hero{flex-direction:column}.right{width:100%} .wrap{margin:18px}}
</style>
</head>
<body>
  <div class="bg-wrap">
    <!-- Video background: file 'background.mp4' if available; otherwise CSS slideshow fallback will show images -->
    <video id="bgVideo" class="bg-video" autoplay muted loop playsinline>
      <source src="assets/background.mp4" type="video/mp4">
    </video>
    <div id="bgFallback" class="bg-slideshow" style="--img-0:url('assets/img1.jpg');--img-1:url('assets/img2.jpg');--img-2:url('assets/img3.jpg');--img-3:url('assets/img4.jpg');"></div>
  </div>

  <main class="wrap">
    <header>
      <div class="brand">NutriAdryan • CalorieSnap Pro</div>
      <div style="margin-left:auto" class="muted">Estimativas rápidas • Em português</div>
    </header>

    <section class="hero" style="margin-top:18px">
      <div class="left card">
        <h1>Identifique alimentos pela foto e veja estimativa de calorias</h1>
        <p class="lead">Tire ou envie uma foto do prato. O sistema tenta identificar o alimento, mostra a porcentagem de confiança e uma estimativa de calorias por porção.</p>

        <label for="file">1) Escolha uma foto</label>
        <input id="file" type="file" accept="image/*"/>

        <div style="margin-top:10px">
          <label for="size">2) Tamanho da porção</label>
          <select id="size"><option value="0.5">Meia porção (~0.5x)</option><option value="1" selected>Porção média (~1x)</option><option value="1.5">Porção 1.5x</option><option value="2">Porção grande (~2x)</option></select>
        </div>

        <div style="margin-top:12px">
          <button id="analyze" class="btn">Analisar imagem</button>
          <button id="clear" class="btn ghost" style="margin-left:8px">Limpar</button>
        </div>

        <div class="preview" id="preview" aria-hidden="true" style="display:none;margin-top:12px">
          <img id="previewImg" class="preview-img" src="" alt="Preview da imagem">
        </div>

        <div class="results" id="results" aria-live="polite"></div>

        <div style="margin-top:10px" class="muted">Observação: resultados são estimativas. Para uso clínico, consulte um profissional.</div>
      </div>

      <aside class="right card">
        <h3 style="margin:0 0 8px">Histórico rápido</h3>
        <div id="history" class="muted">Nenhuma análise ainda.</div>
        <hr style="margin:12px 0;border:none;border-top:1px solid #f0f0f0" />
        <h3 style="margin:0 0 8px">Chat com IA (nutri)</h3>
        <p class="muted" style="margin:0 0 12px">Converse com o assistente para tirar dúvidas sobre alimentos, porções e dicas.</p>
        <button id="openChat" class="btn" style="width:100%">Abrir chat</button>
        <hr style="margin:12px 0;border:none;border-top:1px solid #f0f0f0" />
        <div class="muted" style="font-size:0.95rem">Quer vender planos? Adicione botão para WhatsApp na sua página.</div>
      </aside>
    </section>

    <footer style="text-align:center;color:white;margin-top:30px">
      © 2025 NutriAdryan — CalorieSnap Pro
    </footer>
  </main>

  <!-- Chat widget -->
  <div class="chat-toggle">
    <button id="chatBtn" class="chat-btn">AI</button>
  </div>
  <div id="chatPanel" class="chat-panel" style="display:none">
    <div class="chat-header">Nutri AI — Assistente</div>
    <div id="chatBody" class="chat-body"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="Pergunte algo sobre nutrição..." />
      <button id="chatSend" class="btn">Enviar</button>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
<script>
// --- MobileNet + UI logic ---
let model;
const fileEl = document.getElementById('file');
const previewWrap = document.getElementById('preview');
const previewImg = document.getElementById('previewImg');
const analyzeBtn = document.getElementById('analyze');
const clearBtn = document.getElementById('clear');
const sizeEl = document.getElementById('size');
const resultsEl = document.getElementById('results');
const historyEl = document.getElementById('history');

const foodMap = {
  'banana': ['Banana (1 unid)', 105],
  'maça': ['Maçã (1 unid)', 95],
  'maca': ['Maçã (1 unid)', 95],
  'laranja': ['Laranja (1 unid)', 62],
  'pizza': ['Fatia de pizza', 285],
  'hotdog': ['Cachorro-quente', 290],
  'hamburger': ['Hambúrguer', 354],
  'frango': ['Frango grelhado (100g)', 165],
  'arroz': ['Arroz branco (1 concha)', 130],
  'feijão': ['Feijão (1 concha)', 76],
  'pao': ['Pão francês (1 unidade)', 135],
  'pão': ['Pão francês (1 unidade)', 135],
  'coxinha': ['Coxinha média', 250],
  'brigadeiro': ['Brigadeiro (1 unidade)', 80],
  'acai': ['Açaí (tigela média)', 300],
  'sushi': ['Sushi (1 unidade)', 60],
  'bolo': ['Fatia de bolo', 350],
  'batata frita': ['Batata frita (porção média)', 365],
  'salada': ['Salada (tigela)', 150],
  'ovos': ['Ovo (1 unidade)', 78],
  'egg': ['Ovo (1 unidade)', 78]
};

function findFoodEstimate(label){
  label = label.toLowerCase();
  for(const key in foodMap){
    if(label.includes(key)) return foodMap[key];
  }
  const words = label.split(/[, ]+/);
  for(const w of words){
    if(foodMap[w]) return foodMap[w];
  }
  return [label, null];
}

async function loadModel(){
  resultsEl.innerHTML = '<div class="muted">Carregando modelo...</div>';
  try{
    model = await mobilenet.load();
    resultsEl.innerHTML = '<div class="muted">Modelo carregado — envie uma foto e clique em "Analisar imagem".</div>';
  }catch(e){
    console.error(e);
    resultsEl.innerHTML = '<div class="muted">Erro ao carregar modelo. Verifique sua conexão.</div>';
  }
}
loadModel();

fileEl.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  previewImg.src = url;
  previewWrap.style.display = 'block';
  resultsEl.innerHTML = '';
});

clearBtn.addEventListener('click', ()=>{
  fileEl.value = '';
  previewImg.src = '';
  previewWrap.style.display = 'none';
  resultsEl.innerHTML = '';
});

analyzeBtn.addEventListener('click', async ()=>{
  if(!model){ alert('Ainda carregando o modelo — aguarde alguns segundos.'); return; }
  if(!previewImg.src){ alert('Selecione uma imagem primeiro.'); return; }
  resultsEl.innerHTML = '<div class="muted">Analisando...</div>';
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.src = previewImg.src;
  img.onload = async ()=>{
    const predictions = await model.classify(img);
    if(!predictions || predictions.length === 0){ resultsEl.innerHTML = '<div class="muted">Nenhuma previsão encontrada.</div>'; return; }
    resultsEl.innerHTML = '';
    const portion = parseFloat(sizeEl.value || '1');
    let historyTxt = '';
    predictions.slice(0,4).forEach(pred=>{
      const [display, cal] = findFoodEstimate(pred.className);
      const conf = (pred.probability*100).toFixed(1) + '%';
      const est = cal ? Math.round(cal * portion) + ' kcal' : 'Estimativa indisponível';
      const item = document.createElement('div');
      item.className = 'pred-item';
      item.innerHTML = `<div><strong>${display}</strong><div class="muted small">${pred.className} — confiança ${conf}</div></div><div style="text-align:right"><div style="font-weight:800">${est}</div></div>`;
      resultsEl.appendChild(item);
      historyTxt += `${display} — ${est} (${conf})\n`;
    });
    // atualizar histórico
    historyEl.textContent = historyTxt;
  };
  img.onerror = ()=>{ resultsEl.innerHTML = '<div class="muted">Erro ao carregar a imagem.</div>'; };
});

// --- Chat UI + simple proxy call ---
const chatBtn = document.getElementById('chatBtn');
const chatPanel = document.getElementById('chatPanel');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');
const openChat = document.getElementById('openChat');

function formatMessage(text, from='bot'){
  const wrapper = document.createElement('div');
  wrapper.className = 'chat-message';
  const el = document.createElement('div');
  el.className = from === 'user' ? 'msg-user' : 'msg-bot';
  el.innerText = text;
  wrapper.appendChild(el);
  return wrapper;
}

chatBtn.addEventListener('click', ()=>{ chatPanel.style.display = chatPanel.style.display === 'none' ? 'flex' : 'none'; });
openChat.addEventListener('click', ()=>{ chatPanel.style.display = 'flex'; window.scrollTo(0,document.body.scrollHeight); });
chatSend.addEventListener('click', sendChat);
chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });

async function sendChat(){
  const text = chatInput.value.trim();
  if(!text) return;
  chatBody.appendChild(formatMessage(text,'user'));
  chatInput.value = '';
  // placeholder bot reply while waiting
  const loading = formatMessage('Pensando...', 'bot');
  chatBody.appendChild(loading);
  chatBody.scrollTop = chatBody.scrollHeight;
  try{
    // IMPORTANT: This endpoint is a placeholder. Read README to create a server-side proxy that calls OpenAI.
    const res = await fetch('/api/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({message:text})
    });
    const data = await res.json();
    chatBody.removeChild(loading);
    if(data && data.reply){
      chatBody.appendChild(formatMessage(data.reply, 'bot'));
    } else {
      chatBody.appendChild(formatMessage('Desculpe, não consegui responder agora.','bot'));
    }
  }catch(err){
    chatBody.removeChild(loading);
    chatBody.appendChild(formatMessage('Erro na conexão com o serviço de IA. Veja o README para configurar.','bot'));
    console.error(err);
  }
  chatBody.scrollTop = chatBody.scrollHeight;
}

// hide video if not available -> fallback will be slideshow (CSS)
const bgVideo = document.getElementById('bgVideo');
bgVideo.addEventListener('error', ()=>{ bgVideo.style.display='none'; document.getElementById('bgFallback').style.display='block'; });
bgVideo.addEventListener('loadeddata', ()=>{ document.getElementById('bgFallback').style.display='none'; });

</script>
</body>
</html>
